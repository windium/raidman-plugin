<Agent>
  <Name>Raidman</Name>
  <Variables>
    <Variable Help="The internal URL for the Raidman service." Desc="Service URL" Default="http://127.0.0.1:9876/api/internal/push">SERVICE_URL</Variable>
  </Variables>
  <Script>
    <![CDATA[
    #!/bin/bash
    ############
    {0}
    ############
    # Received arguments from Unraid are Environment Variables:
    # EVENT, SUBJECT, DESCRIPTION, IMPORTANCE, LINK

    # Validating and logging
    LOG_FILE="/var/log/raidman_agent.log"
    echo "$(date) - [Raidman Agent] Environment: EVENT='$EVENT' SUBJECT='$SUBJECT' IMPORTANCE='$IMPORTANCE'" >> $LOG_FILE

    # Construct JSON using a temporary file to avoid shell variable issues
    PAYLOAD_FILE="/tmp/raidman_payload.json"
    
    # Escape quotes in variables for JSON safety
    safe_event=$(echo "$EVENT" | sed 's/"/\\"/g')
    safe_severity=$(echo "$IMPORTANCE" | sed 's/"/\\"/g')
    safe_subject=$(echo "$SUBJECT" | sed 's/"/\\"/g')
    safe_description=$(echo "$DESCRIPTION" | sed 's/"/\\"/g')
    safe_link=$(echo "$LINK" | sed 's/"/\\"/g')

    cat > "$PAYLOAD_FILE" <<EOF
{
  "event": "$safe_event",
  "severity": "$safe_severity",
  "subject": "$safe_subject",
  "description": "$safe_description",
  "link": "$safe_link",
  "content": ""
}
EOF

    # Log the payload content for debugging
    echo "$(date) - [Raidman Agent] Payload Content:" >> $LOG_FILE
    cat "$PAYLOAD_FILE" >> $LOG_FILE

    # Send to local Raidman instance
    echo "$(date) - [Raidman Agent] Sending to $SERVICE_URL..." >> $LOG_FILE
    RESPONSE=$(curl -s -v -X POST -H "Content-Type: application/json" -d @"$PAYLOAD_FILE" "$SERVICE_URL" 2>&1)
    echo "$(date) - [Raidman Agent] Curl Response: $RESPONSE" >> $LOG_FILE
    
    # Cleanup
    rm -f "$PAYLOAD_FILE"
    ]]>
    ]]>
  </Script>
</Agent>
