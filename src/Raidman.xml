<?xml version="1.0" encoding="utf-8"?>
<Agent>
  <Name>Raidman</Name>
  <Variables>
    <Variable Help="The internal URL for the Raidman service." Desc="Service URL" Default="http://127.0.0.1:9876/api/internal/push">SERVICE_URL</Variable>
  </Variables>
  <Script>
<![CDATA[
#!/bin/bash
{0}

# Logging
LOG_FILE="/var/log/raidman_agent.log"
echo "$(date) - [Raidman Agent] Script started." >> $LOG_FILE
echo "$(date) - [Raidman Agent] Environment: EVENT='$EVENT' SUBJECT='$SUBJECT' IMPORTANCE='$IMPORTANCE'" >> $LOG_FILE

# Construct JSON payload
PAYLOAD_FILE="/tmp/raidman_payload_$$.json"

# Escape quotes for JSON
safe_event=$(echo "$EVENT" | sed 's/"/\\"/g')
safe_severity=$(echo "$IMPORTANCE" | sed 's/"/\\"/g')
safe_subject=$(echo "$SUBJECT" | sed 's/"/\\"/g')
safe_description=$(echo "$DESCRIPTION" | sed 's/"/\\"/g')
safe_link=$(echo "$LINK" | sed 's/"/\\"/g')

# Build JSON
cat > "$PAYLOAD_FILE" <<EOF
{
  "event": "$safe_event",
  "severity": "$safe_severity",
  "subject": "$safe_subject",
  "description": "$safe_description",
  "link": "$safe_link",
  "content": ""
}
EOF

# Log payload
echo "$(date) - [Raidman Agent] Payload:" >> $LOG_FILE
cat "$PAYLOAD_FILE" >> $LOG_FILE

# Send to Raidman service
echo "$(date) - [Raidman Agent] Sending to $SERVICE_URL..." >> $LOG_FILE
RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST -H "Content-Type: application/json" -d @"$PAYLOAD_FILE" "$SERVICE_URL" 2>&1)
echo "$(date) - [Raidman Agent] Response: $RESPONSE" >> $LOG_FILE

# Cleanup
rm -f "$PAYLOAD_FILE"

echo "$(date) - [Raidman Agent] Script completed." >> $LOG_FILE
]]>
  </Script>
</Agent>
