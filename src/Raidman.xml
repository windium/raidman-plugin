<Agent>
  <Name>Raidman</Name>
  <Variables>
    <Variable Help="The internal URL for the Raidman service." Desc="Service URL" Default="http://127.0.0.1:9876/api/internal/push">SERVICE_URL</Variable>
  </Variables>
  <Script>
    <![CDATA[
    #!/bin/bash
    ############
    {0}
    ############
    # Received arguments from Unraid are Environment Variables:
    # EVENT, SUBJECT, DESCRIPTION, IMPORTANCE, LINK

    # Validating and logging
    LOG_FILE="/var/log/raidman_agent.log"
    echo "$(date) - [Raidman Agent] Environment: EVENT='$EVENT' SUBJECT='$SUBJECT' IMPORTANCE='$IMPORTANCE'" >> $LOG_FILE

    # JSON Payload
    JSON_PAYLOAD=$(cat <<EOF
{
  "event": "$(echo "$EVENT" | sed 's/"/\\"/g')",
  "severity": "$(echo "$IMPORTANCE" | sed 's/"/\\"/g')",
  "subject": "$(echo "$SUBJECT" | sed 's/"/\\"/g')",
  "description": "$(echo "$DESCRIPTION" | sed 's/"/\\"/g')",
  "link": "$(echo "$LINK" | sed 's/"/\\"/g')",
  "content": ""
}
EOF
)
    echo "$(date) - [Raidman Agent] Payload: $JSON_PAYLOAD" >> $LOG_FILE

    # Send to local Raidman instance
    # Use curl with -v for verbose output to log, capture stdout/stderr
    RESPONSE=$(curl -s -v -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" $SERVICE_URL 2>&1)
    echo "$(date) - [Raidman Agent] Curl Response: $RESPONSE" >> $LOG_FILE
    ]]>
  </Script>
</Agent>
