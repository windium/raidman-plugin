<?xml version="1.0" encoding="utf-8"?>
<Agent>
  <Name>Raidman</Name>
  <Variables>
    <Variable Help="The internal URL for the Raidman service." Desc="Service URL" Default="http://127.0.0.1:9876/api/internal/push">SERVICE_URL</Variable>
  </Variables>
  <Script>
    <![CDATA[
    #!/bin/bash
    # Debug logging immediately
    echo "$(date) - [Raidman Agent] Script started." >> /var/log/raidman_agent.log

    # Received arguments from Unraid are Environment Variables:
    # EVENT, SUBJECT, DESCRIPTION, IMPORTANCE, LINK

    # Validating and logging
    LOG_FILE="/var/log/raidman_agent.log"
    echo "$(date) - [Raidman Agent] Environment: EVENT='$EVENT' SUBJECT='$SUBJECT' IMPORTANCE='$IMPORTANCE'" >> $LOG_FILE

    # Construct JSON using printf to avoid heredoc indentation issues
    PAYLOAD_FILE="/tmp/raidman_payload.json"
    
    # Escape quotes in variables for JSON safety
    safe_event=$(echo "$EVENT" | sed 's/"/\\"/g')
    safe_severity=$(echo "$IMPORTANCE" | sed 's/"/\\"/g')
    safe_subject=$(echo "$SUBJECT" | sed 's/"/\\"/g')
    safe_description=$(echo "$DESCRIPTION" | sed 's/"/\\"/g')
    safe_link=$(echo "$LINK" | sed 's/"/\\"/g')

    # Create empty file
    echo "" > "$PAYLOAD_FILE"

    # Append JSON parts
    echo "{" > "$PAYLOAD_FILE"
    echo "  \"event\": \"$safe_event\"," >> "$PAYLOAD_FILE"
    echo "  \"severity\": \"$safe_severity\"," >> "$PAYLOAD_FILE"
    echo "  \"subject\": \"$safe_subject\"," >> "$PAYLOAD_FILE"
    echo "  \"description\": \"$safe_description\"," >> "$PAYLOAD_FILE"
    echo "  \"link\": \"$safe_link\"," >> "$PAYLOAD_FILE"
    echo "  \"content\": \"\"" >> "$PAYLOAD_FILE"
    echo "}" >> "$PAYLOAD_FILE"

    # Log the payload content for debugging
    echo "$(date) - [Raidman Agent] Payload Content:" >> $LOG_FILE
    cat "$PAYLOAD_FILE" >> $LOG_FILE

    # Send to local Raidman instance
    echo "$(date) - [Raidman Agent] Sending to $SERVICE_URL..." >> $LOG_FILE
    RESPONSE=$(curl -s -v -X POST -H "Content-Type: application/json" -d @"$PAYLOAD_FILE" "$SERVICE_URL" 2>&1)
    echo "$(date) - [Raidman Agent] Curl Response: $RESPONSE" >> $LOG_FILE
    
    # Cleanup
    rm -f "$PAYLOAD_FILE"
    ]]>
  </Script>
</Agent>
